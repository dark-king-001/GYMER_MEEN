<!doctype html>
<html>
   <head>
      <meta charset='utf-8'>
      <meta name='viewport' content='width=device-width, initial-scale=1'>
      <title>Order confirmation Page</title>
      <link href='https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css' rel='stylesheet'>
      <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet'>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;500&display=swap">
      <style>@import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
         * {
         padding: 0;
         margin: 0;
         box-sizing: border-box;
         font-family: 'Outfit', sans-serif;
         }
         body {
         background-color: #000;
         }
         #order-heading {
         background-color: #edf4f7;
         position: relative;
         border-top-left-radius: 25px;
         border-top-right-radius: 25px;
         max-width: 800px;
         padding-top: 20px;
         margin: 30px auto 0px
         }
         #order-heading .text-uppercase {
         font-size: 0.9rem;
         color: #777;
         font-weight: 600
         }
         #order-heading .h4 {
         font-weight: 600
         }
         #order-heading .h4+div p {
         font-size: 0.8rem;
         color: #777
         }
         .close {
         padding: 10px 15px;
         background-color: #777;
         border-radius: 50%;
         position: absolute;
         right: -15px;
         display: none;
         top: -20px
         }

         .Shipping_Address p{
            font-size: 2rem;
         }

         .wrapper {
         padding: 0px 50px 50px;
         max-width: 800px;
         margin: 0px auto 40px;
         border-bottom-left-radius: 25px;
         border-bottom-right-radius: 25px
         }
         .table th {
         border-top: none
         }
         .table thead tr.text-uppercase th {
         font-size: 0.8rem;
         padding-left: 0px;
         padding-right: 0px
         }
         .table tbody tr th,
         .table tbody tr td {
         font-size: 0.9rem;
         padding-left: 0px;
         padding-right: 0px;
         padding-bottom: 5px
         }
         .table-responsive {
         height: 100px
         }
         .list div b {
         font-size: 0.8rem
         }
         .list .order-item {
         font-weight: 600;
         color: #6db3ec
         }
         .list:hover {
         background-color: #f4f4f4;
         cursor: pointer;
         border-radius: 5px
         }
         label {
         margin-bottom: 0;
         padding: 0;
         font-weight: 900
         }
         button.btn {
         font-size: 0.9rem;
         }
         .price {
         color: #5cb99a;
         font-weight: 700
         }
         p.text-justify {
         font-size: 0.9rem;
         margin: 0
         }
         .row {
         margin: 0px
         }
         .subscriptions {
         border: 1px solid #ddd;
         border-left: 5px solid #ffa500;
         padding: 10px
         }
         .subscriptions div {
         font-size: 0.9rem
         }
         @media(max-width: 425px) {
         .wrapper {
         padding: 20px
         }
         body {
         font-size: 0.85rem;
         padding: 2rem;
         }
         .subscriptions div {
         padding-left: 5px
         }
         img+label {
         font-size: 0.75rem
         }
         }
      </style>
      <script type='text/javascript' src=''></script>
      <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js'></script>
      <script type='text/javascript' src='https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js'></script>
   </head>
   <body oncontextmenu='return false' class='snippet-body'>
      <div class="d-flex flex-column justify-content-center align-items-center" id="order-heading">
         <div class="d-flex flex-column justify-content-center align-items-center m-2">
            <img src="../assets/logo.png" style="height: 5vh;margin-bottom: 1rem;">
            <h1 style="font-size: 2rem;">WhiteWolf International - Confirm Order</h1>
         </div>
         <div class="h4 date">Monday, November 27, 2023</div>
         <div class="btn close text-white"> &times; </div>
      </div>
      <div class="wrapper bg-white pt-3">
        <table class="table table-bordered table-striped table-responsive">
            <thead>
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Price</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Total (â‚¹)</th>
                </tr>
            </thead>
            <tbody class="allItems">
            </tbody>
        </table>
        <div class="d-flex justify-content-start align-items-center  pl-3">
         <div class="text-muted">Shipping</div>
         <div class="ml-auto"> <label>Free</label> </div>
      </div>
      <div class="d-flex justify-content-between align-items-center mt-2 pb-4 pl-3">
         <div class="text-muted w-100">
             <input type="text" class="form-control" id="couponInput" placeholder="Enter Coupon">
         </div>
         <div class="ml-3">
             <button class="btn btn-dark btn-apply-coupon coupon_Button">Apply</button>
         </div>
         <div class="ml-4">
            <button class="btn btn-dark btn-apply-coupon coupon_remove_Button">Remove</button>
         </div>
     </div>
         <div class="table-responsive">
            <table class="table table-borderless">
               <thead>
                  <tr class="text-uppercase text-muted">
                     <th scope="col"></th>
                     <th scope="col" class="text-right">Total</th>
                  </tr>
               </thead>
               <tbody>
                  <tr>
                     <th scope="row"></th>
                     <td class="text-right total"><b>&#8377;</b></td>
                  </tr>
               </tbody>
            </table>
         </div>
         <p>Online Payment gateway in Development</p>
         <div class="row border rounded p-1 my-3">
            <div class="col-md-6 py-3">
               <div class="d-flex flex-column align-items start Shipping_Address"></div>
            </div>
         </div>
         <button class="btn btn-dark proceedToPay">Proceed</button>
      </div>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
      <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
      <script>
         let Total = 0;
            document.querySelector('.coupon_Button').addEventListener('click', async (req, res) => {
               let code = document.querySelector('#couponInput').value;
               await axios.get(`/coupons/${code}`)
               .then(response => response.data)
               .then(coupon => {
                  document.querySelector('.total').innerHTML = `<b>&#8377;${Total} -> ${Total - Total*((coupon.discount)/100)}</b>`;
               })
               .catch(err => console.log(err))
            })
            document.querySelector('.coupon_remove_Button').addEventListener('click', async (req, res) => {
               document.querySelector('#couponInput').value = ''
               document.querySelector('.total').innerHTML = `<b>&#8377;${Total}</b>`;
            })
            function dataCell (content) {
               var item = document.createElement('td')
               item.textContent = content;
               return item
            }
            function addTableRow(name, price, quantity) {
               // Get the table body
               var tableBody = document.querySelector('.allItems')

               var row = document.createElement('tr')
               row.append(dataCell(name))
               row.append(dataCell(price))
               row.append(dataCell(quantity))
               row.append(dataCell((price*quantity)))

               tableBody.append(row)
            }
         document.addEventListener('DOMContentLoaded', async () => {
            await axios.get('/getprofile')
            .then(response => response.data.userProfile)
            .then(profile => {
            // name: newUser.name,
            // email: newUser.email,
            // phone: newUser.phone,
            // purchasedProducts: newUser.purchasedProducts
               profile.cart.forEach(async cartItem => {
                  await axios.get(`/api/products/${cartItem.itemId}`)
                    .then(response => response.data)
                    .then(productDetails => {
                     addTableRow(productDetails.name, productDetails.offeredPrice,cartItem.quantity)
                     Total += productDetails.offeredPrice*cartItem.quantity;
                     document.querySelector('.total').innerHTML = `<b>&#8377;${Total}</b>`;
                    })
                    .catch(err => console.log("could not fetch product\n" + err))
               })
               document.querySelector('.Shipping_Address').innerHTML = `
                  <b>Shipping Address</b>
                  <p class="text-justify pt-2">${profile.pincode || ""}</p>
                  <p class="text-justify">${profile.address || ""} ${profile.city || `<a href="/profile">Please Add a City</a>`}</p>
                  <p class="text-justify">${profile.locality || ""} ${profile.landmark || ""}</p>
                  <p class="text-justify">${profile.email}</p>
               `;

                  // Create a new Date object
                  var today = new Date();
                  var year = today.getFullYear();
                  var month = today.getMonth() + 1;
                  var day = today.getDate();
                  var formattedDate = year + '/' + (month < 10 ? '0' + month : month) + '/' + (day < 10 ? '0' + day : day);

                  document.querySelector('.date').textContent = formattedDate;
            })
            .catch(err => {console.log("could not fetch profile\n"+ err)})
         })

         document.addEventListener('DOMContentLoaded', function(){
            document.querySelector('.proceedToPay').addEventListener('click',function(e){
               e.preventDefault();

               const amount = Total;
               let code = document.querySelector('#couponInput').value;

               var formData = {
                  couponCode: code,
                  name: "Wolf Cart Payment",
                  description:"Thank you for your patronage"
               }
         
               $.ajax({
                  url:"/processPayment",
                  type:"POST",
                  data: formData,
                  success:function(res){
                     if(res.success){
                        var options = {
                           "key": ""+res.key_id+"",
                           "amount": ""+res.amount+"",
                           "currency": "INR",
                           "name": ""+res.product_name+"",
                           "description": ""+res.description+"",
                           "image": "https://dummyimage.com/600x400/000/fff",
                           "order_id": ""+res.order_id+"",
                           "handler": function (response){
                              axios.post('/save/order',{ data : response, couponCode: code})
                              .then(res => {
                                window.location.href = '/success'; 
                              })
                              .catch(err => console.log(err))
                           },
                           "prefill": {
                              "contact":""+res.contact+"",
                              "name": ""+res.name+"",
                              "email": ""+res.email+""
                           },
                           "notes" : {
                              "description":""+res.description+""
                           },
                           "theme": {
                              "color": "#2300a3"
                           }
                        };
                        var razorpayObject = new Razorpay(options);
                        razorpayObject.on('payment.failed', function (response){
                              window.location.href = '/failure'
                        });
                        razorpayObject.open();
                     }
                     else{
                        alert(res.msg);
                     }
                  }
               })
         
            });
         });
      </script>
   </body>
</html>